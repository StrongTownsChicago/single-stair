<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single Stair Visualizer — Chicago Single Stair Reform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* ===== DESIGN TOKENS ===== */
    :root {
      --bg-deep: #0B0E13;
      --bg: #12151C;
      --bg-surface: #1A1E28;
      --bg-elevated: #222831;
      --bg-hover: #2A3040;
      --text: #E8E4DC;
      --text-secondary: #A09C94;
      --text-muted: #6B6860;
      --accent: #7B9EF0;
      --accent-dim: rgba(123, 158, 240, 0.12);
      --current-code: #E07A5A;
      --reform: #5BBF82;
      --reform-dim: rgba(91, 191, 130, 0.08);
      --red: #D64545;
      --orange: #D4903A;
      --yellow: #D9B84A;
      --green: #5BBF82;
      --teal: #3DA89A;
      --border: rgba(255, 255, 255, 0.06);
      --border-light: rgba(255, 255, 255, 0.10);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.25);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at 15% 0%, rgba(123, 158, 240, 0.035) 0%, transparent 50%),
        radial-gradient(ellipse at 85% 100%, rgba(91, 191, 130, 0.025) 0%, transparent 50%);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== HEADER ===== */
    header {
      text-align: center;
      padding: 2.75rem 1.5rem 1.75rem;
      background: linear-gradient(180deg, rgba(123, 158, 240, 0.05) 0%, transparent 100%);
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: 2.4rem;
      font-weight: 400;
      color: #fff;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }
    header p {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-top: 0.6rem;
      font-weight: 300;
      letter-spacing: 0.01em;
    }

    /* ===== CONTROLS ===== */
    .controls {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 1.25rem 1.5rem;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      background: var(--bg-deep);
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .control-group label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      font-weight: 600;
    }
    .control-group select,
    .control-group .btn-group {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-surface);
      color: var(--text);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .control-group select option {
      background: var(--bg-surface);
      color: var(--text);
    }
    .control-group select:hover { border-color: var(--accent); }
    .control-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .btn-group {
      display: flex;
      overflow: hidden;
      padding: 0 !important;
      gap: 0;
    }
    .btn-group button {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-surface);
      color: var(--text-muted);
      border: none;
      border-right: 1px solid var(--border);
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-group button:last-child { border-right: none; }
    .btn-group button.active {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .btn-group button:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--text);
    }

    /* ===== TAB BAR ===== */
    .tab-bar {
      display: flex;
      justify-content: center;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg-deep);
    }
    .tab-bar button {
      font-family: 'Outfit', sans-serif;
      background: transparent;
      color: var(--text-muted);
      border: none;
      border-bottom: 2px solid transparent;
      padding: 0.85rem 2rem;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
      letter-spacing: 0.01em;
    }
    .tab-bar button:hover { color: var(--text-secondary); }
    .tab-bar button.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      font-weight: 600;
    }

    /* ===== FLOOR SELECTOR ===== */
    .floor-selector {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
    }
    .floor-selector button {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-surface);
      color: var(--text-muted);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 0.4rem 0.9rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .floor-selector button:hover:not(.active) {
      border-color: var(--accent);
      color: var(--text-secondary);
      background: var(--bg-elevated);
    }
    .floor-selector button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 16px var(--accent-dim);
    }

    /* ===== NARRATIVE HEADLINE ===== */
    .narrative-headline {
      text-align: center;
      padding: 1rem 1.5rem 0.25rem;
      font-size: 1.05rem;
      font-weight: 400;
      color: var(--text);
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
    }
    .narrative-headline strong {
      color: var(--reform);
      font-weight: 700;
    }

    /* ===== FLOOR NOTE ===== */
    .floor-note {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      padding: 0 1rem 0.5rem;
      font-style: italic;
      font-weight: 300;
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      padding: 1.5rem;
      max-width: 1300px;
      margin: 0 auto;
    }

    /* ===== COMPARATOR ===== */
    .comparator-container {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      justify-content: center;
    }

    .plan-panel {
      flex: 1;
      max-width: 500px;
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      transition: box-shadow 0.3s, border-color 0.3s;
    }
    .plan-panel:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--border-light);
    }
    .plan-panel h3 {
      text-align: center;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .plan-panel h3.current-label { color: var(--current-code); }
    .plan-panel h3.reform-label { color: var(--reform); }
    .plan-panel svg {
      width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-sm);
      background:
        linear-gradient(rgba(255,255,255,0.018) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.018) 1px, transparent 1px);
      background-size: 10px 10px;
      background-color: rgba(255,255,255,0.015);
    }

    /* ===== DELTA PANEL ===== */
    .delta-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.6rem;
      padding: 0.5rem;
      min-width: 140px;
      text-align: center;
      position: relative;
    }
    .delta-panel::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 1px;
      background: linear-gradient(180deg, transparent, var(--border-light) 15%, var(--border-light) 85%, transparent);
      z-index: 0;
    }
    .delta-item {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 0.65rem 0.75rem;
      font-family: 'JetBrains Mono', monospace;
      transition: transform 0.2s, border-color 0.3s, box-shadow 0.3s;
      position: relative;
      z-index: 1;
    }
    .delta-item:hover {
      transform: translateY(-2px);
      border-color: rgba(91, 191, 130, 0.3);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    .delta-item .value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--reform);
      display: block;
      line-height: 1.2;
    }
    .delta-item .label {
      font-size: 0.6rem;
      color: var(--text-muted);
      display: block;
      margin-top: 0.2rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* ===== STATS SECTION ===== */
    .stats-section {
      margin-top: 2rem;
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .stats-section h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .stats-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.85rem;
    }
    .stats-table th, .stats-table td {
      padding: 0.65rem 0.85rem;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }
    .stats-table th:first-child, .stats-table td:first-child { text-align: left; }
    .stats-table th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding-bottom: 0.85rem;
    }
    .stats-table tbody tr {
      transition: background 0.15s;
    }
    .stats-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }
    .stats-table tbody tr:last-child td {
      border-bottom: none;
    }
    .stats-table .diff-positive { color: var(--reform); font-weight: 600; }
    .stats-table .diff-negative { color: var(--red); font-weight: 600; }
    .stats-table .diff-zero { color: var(--text-muted); }

    /* ===== TOOLTIP ===== */
    .tooltip {
      position: fixed;
      background: var(--bg-elevated);
      border: 1px solid var(--accent);
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.85rem;
      font-size: 0.75rem;
      pointer-events: none;
      z-index: 100;
      display: none;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(8px);
    }

    .floor-note {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      padding: 0 1rem 0.5rem;
      font-style: italic;
      font-weight: 300;
    }

    #three-container {
      width: 100%;
      height: 500px;
      background: var(--bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      display: none;
      box-shadow: var(--shadow-md);
    }

    /* ===== FOOTER ===== */
    footer {
      text-align: center;
      padding: 2.5rem 1.5rem;
      color: var(--text-muted);
      font-size: 0.75rem;
      border-top: 1px solid var(--border);
      margin-top: 3rem;
      font-weight: 300;
      letter-spacing: 0.01em;
    }
    footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    footer a:hover {
      color: #fff;
      text-decoration: underline;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      header h1 { font-size: 1.6rem; }
      header p { font-size: 0.85rem; }
      header { padding: 2rem 1rem 1.25rem; }
      .comparator-container {
        flex-direction: column;
        align-items: stretch;
      }
      .plan-panel { max-width: 100%; }
      .delta-panel {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .delta-panel::before { display: none; }
      .controls { gap: 1rem; }
      .main-content { padding: 1rem; }
    }

    /* ===== PRINT ===== */
    @media print {
      body { background: #fff; color: #000; }
      header, .controls, .tab-bar, .floor-selector, footer { display: none; }
      .plan-panel { border: 1px solid #ccc; background: #fff; box-shadow: none; }
      .stats-section { background: #fff; border: 1px solid #ccc; box-shadow: none; }
      .delta-item .value { color: #16a34a; }
      .stats-table .diff-positive { color: #16a34a; }
      .stats-table .diff-negative { color: #dc2626; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Single Stair Visualizer</h1>
    <p>How single stair reform creates bigger, brighter apartments on Chicago's standard lots</p>
  </header>

  <div class="controls">
    <div class="control-group">
      <label>Lot Type</label>
      <select id="lot-select">
        <option value="single">Single (25×125)</option>
        <option value="double">Double (50×125)</option>
        <option value="corner">Corner (25×125)</option>
      </select>
    </div>
    <div class="control-group">
      <label>Stories</label>
      <div class="btn-group" id="stories-group">
        <button data-value="2">2</button>
        <button data-value="3" class="active">3</button>
        <button data-value="4">4</button>
      </div>
    </div>
    <div class="control-group">
      <label>Ground Floor</label>
      <select id="ground-select">
        <option value="residential">Residential</option>
        <option value="commercial">Commercial/Retail</option>
      </select>
    </div>
    <div class="control-group">
      <label>Building Type</label>
      <select id="building-type-select">
        <option value="standard">Standard Block</option>
        <option value="L">L-Shape Courtyard</option>
        <option value="U">U-Shape Courtyard</option>
      </select>
    </div>
  </div>

  <div class="tab-bar">
    <button class="active" data-tab="floorplan">Floor Plan</button>
    <button data-tab="3d">3D View</button>
  </div>

  <div id="floorplan-tab">
    <div class="narrative-headline" id="narrative-headline"></div>
    <div class="floor-selector" id="floor-selector"></div>
    <div class="floor-note" id="floor-note"></div>

    <div class="main-content">
      <div class="comparator-container">
        <div class="plan-panel" id="current-panel">
          <h3 class="current-label">Current Code</h3>
          <div id="current-svg"></div>
        </div>
        <div class="delta-panel" id="delta-panel"></div>
        <div class="plan-panel" id="reform-panel">
          <h3 class="reform-label">Single Stair Reform</h3>
          <div id="reform-svg"></div>
        </div>
      </div>

      <div class="stats-section">
        <h3>Per-Floor Comparison (Floor <span id="stats-floor-num">1</span>)</h3>
        <table class="stats-table" id="per-floor-table">
          <thead>
            <tr><th></th><th>Current Code</th><th>Reform</th><th>Difference</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="stats-section">
        <h3>Whole-Building Summary</h3>
        <table class="stats-table" id="whole-building-table">
          <thead>
            <tr><th></th><th>Current Code</th><th>Reform</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="three-tab" style="display:none">
    <div class="main-content">
      <div id="three-container"></div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <footer>
    Illustrative visualization for advocacy purposes. Not architectural drawings. &mdash;
    <a href="https://www.strongtownschicago.org">Strong Towns Chicago</a> &amp;
    <a href="https://www.abundanthousingil.org">Abundant Housing Illinois</a>
  </footer>

  <script src="layout.js"></script>
  <script src="renderer.js"></script>
  <script src="stats.js"></script>
  <script src="state.js"></script>
  <script src="courtyard.js"></script>
  <script>
    // --- App State ---
    let currentFloorIndex = 2; // Default to floor 3 (0-indexed) where reform impact is visible
    let currentConfig = decodeHashToConfig(window.location.hash);

    // --- DOM refs ---
    const lotSelect = document.getElementById('lot-select');
    const storiesGroup = document.getElementById('stories-group');
    const groundSelect = document.getElementById('ground-select');
    const buildingTypeSelect = document.getElementById('building-type-select');
    const floorSelector = document.getElementById('floor-selector');
    const floorNote = document.getElementById('floor-note');
    const narrativeHeadline = document.getElementById('narrative-headline');
    const currentSvgEl = document.getElementById('current-svg');
    const reformSvgEl = document.getElementById('reform-svg');
    const deltaPanel = document.getElementById('delta-panel');
    const statsFloorNum = document.getElementById('stats-floor-num');
    const perFloorBody = document.querySelector('#per-floor-table tbody');
    const wholeBuildingBody = document.querySelector('#whole-building-table tbody');
    const tooltip = document.getElementById('tooltip');
    const currentPanelLabel = document.querySelector('#current-panel h3');
    const reformPanelLabel = document.querySelector('#reform-panel h3');

    // --- Initialize controls from config ---
    function syncControlsToConfig() {
      lotSelect.value = currentConfig.lot;
      groundSelect.value = currentConfig.ground;
      buildingTypeSelect.value = currentConfig.buildingType || 'standard';
      storiesGroup.querySelectorAll('button').forEach(b => {
        b.classList.toggle('active', b.dataset.value === String(currentConfig.stories));
      });
    }

    // --- Render everything ---
    function render() {
      const config = { lot: currentConfig.lot, stories: currentConfig.stories, ground: currentConfig.ground };
      const buildingType = currentConfig.buildingType || 'standard';
      const isCourtyardMode = buildingType === 'L' || buildingType === 'U';

      const current = generateLayout({ ...config, stair: 'current' });
      const reform = generateLayout({ ...config, stair: 'reform' });

      // Clamp floor index
      if (currentFloorIndex >= currentConfig.stories) {
        currentFloorIndex = currentConfig.stories - 1;
      }

      // Floor selector
      floorSelector.innerHTML = '';
      for (let i = 0; i < currentConfig.stories; i++) {
        const btn = document.createElement('button');
        btn.textContent = `Floor ${i + 1}`;
        btn.classList.toggle('active', i === currentFloorIndex);
        btn.addEventListener('click', () => {
          currentFloorIndex = i;
          render();
        });
        floorSelector.appendChild(btn);
      }

      // Narrative headline
      if (isCourtyardMode) {
        const shapeLabel = buildingType === 'L' ? 'L-Shape' : 'U-Shape';
        narrativeHeadline.innerHTML = `Single stair reform enables <strong>${shapeLabel} courtyard buildings</strong> with apartments facing shared open space for more natural light.`;
      } else if (currentFloorIndex >= 2) {
        const currFloorTemp = current.floors[currentFloorIndex];
        const refFloorTemp = reform.floors[currentFloorIndex];
        const cLiv = currFloorTemp.units.reduce((s, u) => s + u.sqft, 0);
        const rLiv = refFloorTemp.units.reduce((s, u) => s + u.sqft, 0);
        const dArea = Math.round(rLiv - cLiv);
        const dPct = cLiv > 0 ? Math.round(((rLiv - cLiv) / cLiv) * 100) : 0;
        narrativeHeadline.innerHTML = `Current code requires 3 staircases above the 2nd floor, wasting <strong>${dArea} sf (+${dPct}%)</strong> of livable space per floor.`;
      } else if (currentFloorIndex < 2 && currentConfig.stories > 2) {
        narrativeHeadline.innerHTML = 'Floors 1-2 are the same under both codes. <strong>Select Floor 3</strong> to see the difference.';
      } else {
        narrativeHeadline.innerHTML = '';
      }

      // Floor note
      if (!isCourtyardMode) {
        if (currentFloorIndex < 2 && currentConfig.stories > 2) {
          floorNote.textContent = 'Floors 1-2: Same under both codes (single stair allowed below 3rd floor)';
        } else if (currentFloorIndex >= 2) {
          floorNote.textContent = 'Floor 3+: Current code requires multiple staircases — this is where reform makes the difference';
        } else {
          floorNote.textContent = '';
        }
      } else {
        floorNote.textContent = '';
      }

      if (isCourtyardMode) {
        // --- Courtyard mode: standard block on left, courtyard on right ---
        const shapeLabel = buildingType === 'L' ? 'L-Shape' : 'U-Shape';
        currentPanelLabel.textContent = 'Standard Block (Reform)';
        reformPanelLabel.textContent = `Single Stair Reform (${shapeLabel} Courtyard)`;

        // Left panel: standard reform layout
        currentSvgEl.innerHTML = renderFloorPlanSVG(reform, currentFloorIndex);

        // Right panel: courtyard layout
        const cyLayout = generateCourtyardLayout({ shape: buildingType, stories: currentConfig.stories, ground: currentConfig.ground });
        reformSvgEl.innerHTML = renderCourtyardSVG(cyLayout, currentFloorIndex);

        // Delta: compare courtyard total livable vs standard reform
        const refFloor = reform.floors[currentFloorIndex];
        const refLivable = refFloor.units.reduce((s, u) => s + u.sqft, 0);
        const cyLivable = cyLayout.segments.reduce((s, seg) => s + seg.floors[currentFloorIndex].livableSqft, 0);
        const cyWindows = cyLayout.segments.reduce((s, seg) => s + seg.floors[currentFloorIndex].units.reduce((us, u) => us + u.windowWalls.length, 0), 0);
        const refWindows = refFloor.units.reduce((s, u) => s + u.windowWalls.length, 0);

        deltaPanel.innerHTML = '';
        function addDelta(value, unit, label) {
          const sign = value > 0 ? '+' : value === 0 ? '' : '';
          const d = document.createElement('div');
          d.className = 'delta-item';
          d.innerHTML = `<span class="value">${sign}${value}${unit}</span><span class="label">${label}</span>`;
          deltaPanel.appendChild(d);
        }
        addDelta(Math.round(cyLivable - refLivable), ' sf', 'Livable Area');
        addDelta(cyWindows - refWindows, '', 'Window Walls');
        addDelta(Math.round(cyLayout.courtyard.area), ' sf', 'Courtyard Space');

        // Stats tables for courtyard mode (simplified)
        statsFloorNum.textContent = currentFloorIndex + 1;
        perFloorBody.innerHTML = '';
        wholeBuildingBody.innerHTML = '';

      } else {
        // --- Standard mode ---
        currentPanelLabel.textContent = 'Current Code';
        reformPanelLabel.textContent = 'Single Stair Reform';

        // SVG
        currentSvgEl.innerHTML = renderFloorPlanSVG(current, currentFloorIndex);
        reformSvgEl.innerHTML = renderFloorPlanSVG(reform, currentFloorIndex);

        // Deltas for this floor
        const currFloor = current.floors[currentFloorIndex];
        const refFloor = reform.floors[currentFloorIndex];
        const currLivable = currFloor.units.reduce((s, u) => s + u.sqft, 0);
        const refLivable = refFloor.units.reduce((s, u) => s + u.sqft, 0);
        const deltaArea = refLivable - currLivable;
        const deltaPct = currLivable > 0 ? ((deltaArea / currLivable) * 100).toFixed(0) : '0';
        const currWinWalls = currFloor.units.reduce((s, u) => s + u.windowWalls.length, 0);
        const refWinWalls = refFloor.units.reduce((s, u) => s + u.windowWalls.length, 0);
        const currBR = currFloor.units.reduce((s, u) => s + u.bedrooms, 0);
        const refBR = refFloor.units.reduce((s, u) => s + u.bedrooms, 0);

        deltaPanel.innerHTML = '';
        function addDelta(value, unit, label) {
          const sign = value > 0 ? '+' : value === 0 ? '' : '';
          const d = document.createElement('div');
          d.className = 'delta-item';
          d.innerHTML = `<span class="value">${sign}${value}${unit}</span><span class="label">${label}</span>`;
          deltaPanel.appendChild(d);
        }
        addDelta(Math.round(deltaArea), ' sf', 'Livable Area');
        addDelta(Number(deltaPct), '%', 'More Space');
        addDelta(refFloor.staircases.length - currFloor.staircases.length, '', 'Staircases');
        addDelta(refWinWalls - currWinWalls, '', 'Window Walls');
        addDelta(refBR - currBR, '', 'Bedrooms');

        // Stats tables
        const fullStats = computeStats(current, reform);
        statsFloorNum.textContent = currentFloorIndex + 1;

        // Per-floor table
        const pf = fullStats.perFloor[currentFloorIndex];
        perFloorBody.innerHTML = '';
        function addStatRow(table, label, curr, ref, diff, suffix) {
          const tr = document.createElement('tr');
          const diffClass = diff > 0 ? 'diff-positive' : diff < 0 ? 'diff-negative' : 'diff-zero';
          const diffStr = diff > 0 ? `+${diff}${suffix || ''}` : diff === 0 ? '\u2014' : `${diff}${suffix || ''}`;
          tr.innerHTML = `<td>${label}</td><td>${curr}</td><td>${ref}</td><td class="${diffClass}">${diffStr}</td>`;
          table.appendChild(tr);
        }
        addStatRow(perFloorBody, 'Livable Area', `${Math.round(pf.current.livableArea)} sf`, `${Math.round(pf.reform.livableArea)} sf`, Math.round(pf.reform.livableArea - pf.current.livableArea), ' sf');
        addStatRow(perFloorBody, 'Units', pf.current.units, pf.reform.units, pf.reform.units - pf.current.units);
        addStatRow(perFloorBody, 'Avg Unit Size', `${Math.round(pf.current.avgUnitSize)} sf`, `${Math.round(pf.reform.avgUnitSize)} sf`, Math.round(pf.reform.avgUnitSize - pf.current.avgUnitSize), ' sf');
        addStatRow(perFloorBody, 'Bedrooms (est.)', pf.current.bedrooms, pf.reform.bedrooms, pf.reform.bedrooms - pf.current.bedrooms);
        addStatRow(perFloorBody, 'Window Walls', pf.current.windowWalls, pf.reform.windowWalls, pf.reform.windowWalls - pf.current.windowWalls);
        addStatRow(perFloorBody, 'Staircases', pf.current.staircases, pf.reform.staircases, pf.reform.staircases - pf.current.staircases);
        addStatRow(perFloorBody, 'Circulation', `${Math.round(pf.current.circulationArea)} sf`, `${Math.round(pf.reform.circulationArea)} sf`, Math.round(pf.reform.circulationArea - pf.current.circulationArea), ' sf');

        // Whole-building table
        wholeBuildingBody.innerHTML = '';
        const wb = fullStats.wholeBuilding;
        function addWbRow(label, curr, ref) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${label}</td><td>${curr}</td><td>${ref}</td>`;
          wholeBuildingBody.appendChild(tr);
        }
        addWbRow('Total Units', wb.current.totalUnits, wb.reform.totalUnits);
        addWbRow('Total Bedrooms', wb.current.totalBedrooms, wb.reform.totalBedrooms);
        addWbRow('Avg Unit Size', `${Math.round(wb.current.avgUnitSize)} sf`, `${Math.round(wb.reform.avgUnitSize)} sf`);
        addWbRow('Total Livable Area', `${Math.round(wb.current.totalLivableArea)} sf`, `${Math.round(wb.reform.totalLivableArea)} sf`);
        addWbRow('Space Lost to Stairs/Halls', `${Math.round(wb.current.totalCirculation)} sf`, `${Math.round(wb.reform.totalCirculation)} sf`);
      }

      // Update URL hash
      window.history.replaceState(null, '', encodeConfigToHash(currentConfig));

      // Set up hover interactions
      setupHoverInteractions();
    }

    // --- Hover interactions ---
    function setupHoverInteractions() {
      document.querySelectorAll('[data-type="unit"]').forEach(el => {
        el.addEventListener('mouseenter', (e) => {
          el.style.opacity = '0.7';
          const id = el.getAttribute('data-id');
          tooltip.style.display = 'block';
          tooltip.textContent = `Unit ${id}`;
        });
        el.addEventListener('mousemove', (e) => {
          tooltip.style.left = (e.clientX + 12) + 'px';
          tooltip.style.top = (e.clientY + 12) + 'px';
        });
        el.addEventListener('mouseleave', () => {
          el.style.opacity = '1';
          tooltip.style.display = 'none';
        });
      });

      document.querySelectorAll('[data-type="staircase"]').forEach(el => {
        el.addEventListener('mouseenter', (e) => {
          el.style.opacity = '1';
          const w = parseFloat(el.getAttribute('width'));
          const d = parseFloat(el.getAttribute('height'));
          tooltip.style.display = 'block';
          tooltip.textContent = `Staircase: ${Math.round(w * d)} sf consumed`;
        });
        el.addEventListener('mousemove', (e) => {
          tooltip.style.left = (e.clientX + 12) + 'px';
          tooltip.style.top = (e.clientY + 12) + 'px';
        });
        el.addEventListener('mouseleave', () => {
          el.style.opacity = '0.8';
          tooltip.style.display = 'none';
        });
      });

      document.querySelectorAll('[data-type="window-wall"]').forEach(el => {
        el.addEventListener('mouseenter', () => {
          el.setAttribute('stroke-width', '2');
          tooltip.style.display = 'block';
          tooltip.textContent = `Window wall: natural light access (${el.getAttribute('data-wall')})`;
        });
        el.addEventListener('mousemove', (e) => {
          tooltip.style.left = (e.clientX + 12) + 'px';
          tooltip.style.top = (e.clientY + 12) + 'px';
        });
        el.addEventListener('mouseleave', () => {
          el.setAttribute('stroke-width', '1');
          tooltip.style.display = 'none';
        });
      });
    }

    // --- Event listeners ---
    lotSelect.addEventListener('change', () => {
      currentConfig.lot = lotSelect.value;
      render();
    });

    groundSelect.addEventListener('change', () => {
      currentConfig.ground = groundSelect.value;
      render();
    });

    buildingTypeSelect.addEventListener('change', () => {
      currentConfig.buildingType = buildingTypeSelect.value;
      render();
    });

    storiesGroup.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        currentConfig.stories = parseInt(btn.dataset.value, 10);
        storiesGroup.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
      });
    });

    // Tab switching
    document.querySelectorAll('.tab-bar button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('floorplan-tab').style.display = tab === 'floorplan' ? '' : 'none';
        document.getElementById('three-tab').style.display = tab === '3d' ? '' : 'none';
        if (tab === '3d') render3D();
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft' && currentFloorIndex > 0) {
        currentFloorIndex--;
        render();
      } else if (e.key === 'ArrowRight' && currentFloorIndex < currentConfig.stories - 1) {
        currentFloorIndex++;
        render();
      }
    });

    // Hash change
    window.addEventListener('hashchange', () => {
      currentConfig = decodeHashToConfig(window.location.hash);
      syncControlsToConfig();
      render();
    });

    // 3D placeholder
    function render3D() {
      const container = document.getElementById('three-container');
      container.style.display = 'block';
      container.innerHTML = '<p style="text-align:center;padding:2rem;color:var(--text-muted)">3D view — Stage 2 (coming soon)</p>';
    }

    // --- Init ---
    syncControlsToConfig();
    render();
  </script>
</body>
</html>
